
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Nhân sự - Khaservice</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/khaservice-hr/assets/css/admin_style.css?v=1768978351">
</head>
<body>
<div class="wrapper">
    <!-- Sidebar included via sidebar.php --><nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>KHASERVICE HR</span>
        <!-- Optional Icon for collapsed state -->
        <i class="fas fa-cube" style="display:none;"></i>
    </div>
    <ul class="sidebar-menu">
        <li>
            <a href="/khaservice-hr/admin/index.php" class="">
                <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
            </a>
        </li>
        <li>
            <a href="/khaservice-hr/admin/modules/projects/index.php" class="">
                <i class="fas fa-building"></i> <span>Quản lý Dự án</span>
            </a>
        </li>
        <li>
            <a href="/khaservice-hr/admin/modules/employees/index.php" class="">
                <i class="fas fa-user-tie"></i> <span>Quản lý Nhân sự</span>
            </a>
        </li>
        <li>
            <a href="/khaservice-hr/admin/modules/employees/pending_docs.php" class="" style="position: relative;">
                <i class="fas fa-file-signature"></i> <span>Duyệt hồ sơ</span>
                            </a>
        </li>
        <li>
            <a href="/khaservice-hr/admin/modules/contracts/index.php" class="">
                <i class="fas fa-file-contract"></i> <span>Hợp đồng & BH</span>
            </a>
        </li>
        <li>
            <a href="/khaservice-hr/admin/modules/attendance/index.php" class="active">
                <i class="fas fa-clock"></i> <span>Chấm công</span>
            </a>
        </li>
        <li>
            <a href="/khaservice-hr/admin/modules/reports/index.php" class="">
                <i class="fas fa-chart-bar"></i> <span>Báo cáo</span>
            </a>
        </li>
                <li>
            <a href="/khaservice-hr/admin/modules/employees/file_manager.php" class="">
                <i class="fas fa-folder-tree"></i> <span>File Server</span>
            </a>
        </li>
                <li>
            <a href="/khaservice-hr/admin/settings.php" class="">
                <i class="fas fa-cogs"></i> <span>Cấu hình</span>
            </a>
        </li>
    </ul>
</nav>
<div class="main-content">
    <header class="main-header">
    <div class="toggle-sidebar" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </div>
    
    <div style="flex: 1;"></div>

    <div id="theme-toggle" style="margin-right: 20px; cursor: pointer; font-size: 1.2rem; color: var(--text-sub); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s;">
        <i class="fas fa-moon"></i>
    </div>

    <div class="user-info" onclick="this.querySelector('.user-dropdown').classList.toggle('show')">
        <span>Administrator</span>
        <div class="user-avatar">A</div>
        <div class="user-dropdown">
                        <a href="../../change_password.php"><i class="fas fa-key"></i> Đổi mật khẩu</a>
            <a href="../../logout.php" style="color: #dc2626;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
        </div>
    </div>
</header>
    <div class="content-wrapper" style="overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - 65px);">
        <div class="action-header" style="flex-shrink: 0;">
            <div>
                <h1 class="page-title">Bảng Chấm Công - 1/2026 <span style="font-size:0.5em; color:#ccc;">(v4.0 Stable)</span></h1>
                <span class="badge badge-success"><i class="fas fa-pen"></i> Đang mở</span>
            </div>
            <div class="header-actions">
                <form method="GET" style="display: flex; gap: 10px;">
                    <select name="project_id" class="form-control" style="min-width: 200px;" onchange="this.form.submit()">
                        <option value='1' >4S RIVERSIDE GARDEN</option><option value='2' >CANTAVIL PREMIER</option><option value='3' >CITIZEN.TS</option><option value='4' >CITRINE APARTMENT</option><option value='5' >COPAC SQUARE</option><option value='6' >FLORA ANH ĐÀO</option><option value='8' >HOÀNG ANH GIA LAI 2</option><option value='9' >HOMYLAND 2</option><option value='10' >HORIZON</option><option value='11' >HƯNG PHÁT</option><option value='12' >HƯNG PHÁT SILVER STAR</option><option value='13' selected>KHÁNH HỘI 1</option><option value='14' >KHÁNH HỘI 2</option><option value='15' >KHÁNH HỘI 3</option><option value='16' >LAN PHƯƠNG MHBR</option><option value='17' >LÔ R7 AN KHÁNH</option><option value='18' >NHẤT LAN II</option><option value='19' >ORIENT APARTMENT</option><option value='20' >PHỐ GIA PHÚC</option><option value='21' >PHÚ GIA</option><option value='22' >SAI GON METRO PARK</option><option value='23' >SAMSORA RIVERSIDE</option><option value='24' >SCREC II</option><option value='25' >SEN HỒNG A</option><option value='26' >SEN HỒNG BC</option><option value='27' >SÔNG ĐÀ</option><option value='28' >TAM PHÚ</option><option value='29' >TDH - PHƯỚC LONG</option><option value='30' >THE STAR</option><option value='31' >THE USEFUL APARTMENT</option><option value='32' >TOPAZ CITY KHỐI B</option><option value='33' >TOPAZ ELITE PHOENIX 1</option><option value='34' >TOPAZ ELITE PHOENIX 2</option><option value='35' >TOPAZ HOME 2 - BLOCK B</option><option value='36' >VẠN ĐÔ</option><option value='37' >VĂN PHÒNG CÔNG TY</option>                    </select>
                    <select name="month" class="form-control" style="width: 80px;" onchange="this.form.submit()"><option value='1' selected>T1</option><option value='2' >T2</option><option value='3' >T3</option><option value='4' >T4</option><option value='5' >T5</option><option value='6' >T6</option><option value='7' >T7</option><option value='8' >T8</option><option value='9' >T9</option><option value='10' >T10</option><option value='11' >T11</option><option value='12' >T12</option></select>
                    <select name="year" class="form-control" style="width: 100px;" onchange="this.form.submit()"><option value='2023' >2023</option><option value='2024' >2024</option><option value='2025' >2025</option><option value='2026' selected>2026</option><option value='2027' >2027</option><option value='2028' >2028</option><option value='2029' >2029</option><option value='2030' >2030</option></select>
                </form>
                                    <button type="button" class="btn btn-primary" onclick="saveAttendance()"><i class="fas fa-save"></i> Lưu</button>
                    <a href="import.php" class="btn btn-secondary"><i class="fas fa-file-import"></i> Import</a>
                            </div>
        </div>

                    <div class="card" style="padding: 0; overflow: hidden; border: 1px solid var(--border-color); flex: 1; display: flex; flex-direction: column;">
                <!-- Legend -->
                <div style="padding: 8px 15px; border-bottom: 1px solid var(--border-color); background: var(--bg-main); font-size: 0.8rem; flex-shrink: 0;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <span><b>Ký hiệu:</b></span>
                        <span style="color:#24a25c; font-weight:700;">X</span>: Đi làm &nbsp;
                        <span style="color:#3b82f6; font-weight:700;">P</span>: Phép &nbsp;
                        <span style="background:#64748b; color:#fff; font-weight:700; padding:0 3px;">OF</span>: Nghỉ tuần &nbsp;
                        <span style="color:#ef4444; font-weight:700;">L,T</span>: Lễ tết
                        <a href="javascript:void(0)" onclick="$('#moreLegend').slideToggle();" style="margin-left: auto;"><i class="fas fa-info-circle"></i> Thêm</a>
                    </div>
                    <div id="moreLegend" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; font-size: 0.8rem;">
                            <span><b>1/2</b>: Làm nửa ngày</span>
                            <span><b>1/p</b>: Nửa phép, nửa làm</span>
                            <span><b>Ô</b>: Nghỉ ốm</span>
                            <span><b>R</b>: Nghỉ việc riêng</span>
                            <span><b>CĐ</b>: Chế độ (Hiếu, hỉ...)</span>
                            <span><b>ĐH</b>: Đi học/Họp</span>
                            <span><b>Ts</b>: Thai sản</span>
                            <span><b>Nb</b>: Nghỉ bù</span>
                            <span><b>F</b>: Làm lễ, tết</span>
                            <span><b>F1</b>: Làm chủ nhật/ngày nghỉ</span>
                            <span><b>1/F1</b>: Làm nửa ngày CN/nghỉ</span>
                            <span><b>1/lt</b>: Làm nửa ngày lễ/tết</span>
                        </div>
                        <div style="margin-top: 10px; color: var(--text-sub); font-style: italic;">
                            * <b>Ô dưới:</b> Nhập số giờ làm thêm (tăng ca). Nhấp đúp vào ô ký hiệu để đánh dấu nhanh 'X'.
                        </div>
                    </div>
                </div>

                <div class="table-container" style="flex: 1; overflow: auto; position: relative; width: 100%;">
                    <table class="attendance-table table-bordered">
                        <colgroup>
                            <col style="width: 50px; min-width: 50px;">
                            <col style="width: 220px; min-width: 220px;">
                            <col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;"><col style="width: 45px; min-width: 45px;">                            <col style="width: 40px; min-width: 40px;">
                            <col style="width: 40px; min-width: 40px;">
                            <col style="width: 40px; min-width: 40px;">
                            <col style="width: 40px; min-width: 40px;">
                            <col style="width: 40px; min-width: 40px;">
                            <col style="width: 40px; min-width: 40px;">
                            <col style="width: 55px; min-width: 55px;">
                        </colgroup>
                        <thead>
                            <tr style="height: 30px;">
                                <th rowspan="3" class="fix-l" style="left: 0; z-index: 20; text-align: center;">STT</th>
                                <th rowspan="3" class="fix-l" style="left: 50px; z-index: 20; border-right: 2px solid #cbd5e1;">Nhân viên</th>
                                <th colspan="31" class="text-center">Ngày trong tháng</th>
                                <th colspan="3" class="fix-r" style="right: 175px; width: 120px; z-index: 20; border-left: 2px solid #cbd5e1;">Ngày nghỉ</th>
                                <th colspan="3" class="fix-r" style="right: 55px; width: 120px; z-index: 20; border-left: 1px solid #cbd5e1;">Tăng ca</th>
                                <th rowspan="3" class="fix-r" style="right: 0; width: 55px; min-width: 55px; z-index: 20; border-left: 2px solid #cbd5e1;">Tổng</th>
                            </tr>
                            <tr style="height: 25px;">
                                <th class="text-center" style="min-width: 45px;">1</th><th class="text-center" style="min-width: 45px;">2</th><th class="text-center" style="min-width: 45px;">3</th><th class="text-center" style="min-width: 45px;">4</th><th class="text-center" style="min-width: 45px;">5</th><th class="text-center" style="min-width: 45px;">6</th><th class="text-center" style="min-width: 45px;">7</th><th class="text-center" style="min-width: 45px;">8</th><th class="text-center" style="min-width: 45px;">9</th><th class="text-center" style="min-width: 45px;">10</th><th class="text-center" style="min-width: 45px;">11</th><th class="text-center" style="min-width: 45px;">12</th><th class="text-center" style="min-width: 45px;">13</th><th class="text-center" style="min-width: 45px;">14</th><th class="text-center" style="min-width: 45px;">15</th><th class="text-center" style="min-width: 45px;">16</th><th class="text-center" style="min-width: 45px;">17</th><th class="text-center" style="min-width: 45px;">18</th><th class="text-center" style="min-width: 45px;">19</th><th class="text-center" style="min-width: 45px;">20</th><th class="text-center" style="min-width: 45px;">21</th><th class="text-center" style="min-width: 45px;">22</th><th class="text-center" style="min-width: 45px;">23</th><th class="text-center" style="min-width: 45px;">24</th><th class="text-center" style="min-width: 45px;">25</th><th class="text-center" style="min-width: 45px;">26</th><th class="text-center" style="min-width: 45px;">27</th><th class="text-center" style="min-width: 45px;">28</th><th class="text-center" style="min-width: 45px;">29</th><th class="text-center" style="min-width: 45px;">30</th><th class="text-center" style="min-width: 45px;">31</th>                                <th rowspan="2" class="fix-r" style="right: 255px; width: 40px; font-size: 0.7rem; border-left: 2px solid #cbd5e1;">P/CĐ</th>
                                <th rowspan="2" class="fix-r" style="right: 215px; width: 40px; font-size: 0.7rem;">Khác</th>
                                <th rowspan="2" class="fix-r" style="right: 175px; width: 40px; font-size: 0.7rem;">Lễ</th>
                                <th rowspan="2" class="fix-r" style="right: 135px; width: 40px; font-size: 0.7rem; border-left: 1px solid #cbd5e1;">TC</th>
                                <th rowspan="2" class="fix-r" style="right: 95px; width: 40px; font-size: 0.7rem;">CN</th>
                                <th rowspan="2" class="fix-r" style="right: 55px; width: 40px; font-size: 0.7rem;">Lễ</th>
                            </tr>
                            <tr style="height: 25px;">
                                <th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T5</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T6</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T7</th><th class='text-center is-sunday' style='font-size:0.7rem; font-weight:400;'>CN</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T2</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T3</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T4</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T5</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T6</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T7</th><th class='text-center is-sunday' style='font-size:0.7rem; font-weight:400;'>CN</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T2</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T3</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T4</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T5</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T6</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T7</th><th class='text-center is-sunday' style='font-size:0.7rem; font-weight:400;'>CN</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T2</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T3</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T4</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T5</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T6</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T7</th><th class='text-center is-sunday' style='font-size:0.7rem; font-weight:400;'>CN</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T2</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T3</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T4</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T5</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T6</th><th class='text-center ' style='font-size:0.7rem; font-weight:400;'>T7</th>                            </tr>
                        </thead>
                        <tbody>
                                                            <tr data-emp-id="2">
                                    <td class="fix-l" style="left: 0; font-weight: 600; background: #fff; text-align: center;">1</td>
                                    <td class="fix-l" style="left: 50px; border-right: 2px solid #cbd5e1; background: #fff; padding: 4px 8px;">
                                        <div style="color: var(--primary-dark); font-weight: 700; font-size: 0.85rem;">Cao Minh Thắng</div>
                                        <div style="font-size: 0.65rem; color: #64748b;">Ban Công nghệ thông tin - Nhân viên</div>
                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="1" 
                                                       data-is-sunday="0"
                                                       value="L" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="1" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="2" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="2" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="3" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="3" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="is-sunday">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="4" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="4" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="5" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="5" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="6" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="6" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="7" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="7" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="8" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="8" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="9" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="9" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="10" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="10" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="is-sunday">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="11" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="11" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="12" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="12" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="13" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="13" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="14" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="14" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="15" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="15" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="16" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="16" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="17" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="17" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="is-sunday">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="18" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="18" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="19" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="19" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="20" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="20" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="21" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="21" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="22" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="22" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="23" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="23" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="24" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="24" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="is-sunday">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="25" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="25" 
                                                       data-is-sunday="1"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="26" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="26" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="27" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="27" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="28" 
                                                       data-is-sunday="0"
                                                       value="P" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="28" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="29" 
                                                       data-is-sunday="0"
                                                       value="P" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="29" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="30" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="30" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                            <td class="">
                                                                                            <input type="text" class="att-input symbol" 
                                                       data-day="31" 
                                                       data-is-sunday="0"
                                                       value="X" 
                                                       maxlength="4"
                                                       autocomplete="off"
                                                       ondblclick="toggleSymbol(this)"
                                                       onfocus="this.select()">
                                                <input type="text" class="att-input ot" 
                                                       data-day="31" 
                                                       data-is-sunday="0"
                                                       value="" 
                                                       oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"
                                                       autocomplete="off"
                                                       placeholder=""
                                                       onfocus="this.select()">
                                                                                    </td>
                                                                        <td class="fix-r sum-p-cd" style="right: 255px; border-left: 2px solid #cbd5e1; background: #fff;">2</td>
                                    <td class="fix-r sum-other" style="right: 215px; background: #fff;"></td>
                                    <td class="fix-r sum-holiday" style="right: 175px; background: #fff;"></td>
                                    <td class="fix-r sum-ot-normal" style="right: 135px; border-left: 1px solid #cbd5e1; color: #dc2626; background: #fff;"></td>
                                    <td class="fix-r sum-ot-sun" style="right: 95px; color: #dc2626; background: #fff;"></td>
                                    <td class="fix-r sum-ot-hol" style="right: 55px; color: #dc2626; background: #fff;"></td>
                                    <td class="fix-r sum-total" style="right: 0; font-weight:700; color:var(--primary-color); border-left: 2px solid #cbd5e1; background: #fff;">27</td>
                                </tr>
                                                    </tbody>
                    </table>
                </div>
            </div>
            </div>

<style>
/* CSS RESET FOR STABILITY */
.attendance-table { border-collapse: separate; border-spacing: 0; width: max-content; margin: 0; }
.attendance-table th, .attendance-table td { 
    border-right: 1px solid #e2e8f0; 
    border-bottom: 1px solid #e2e8f0; 
    padding: 0; 
    box-sizing: border-box; 
    vertical-align: middle; /* Căn giữa trên dưới */
}

/* HEADER STICKY */
.attendance-table thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 800; } /* High z-index for top header */
.attendance-table thead tr:nth-child(2) th { top: 30px; }
.attendance-table thead tr:nth-child(3) th { top: 55px; }

/* LEFT STICKY */
.fix-l { position: sticky; z-index: 900 !important; background-color: #fff; } /* Body Left > Standard Body (0) */
.attendance-table thead .fix-l { z-index: 1000 !important; background-color: #f8fafc; } /* Header Left > Header Standard (800) */

/* RIGHT STICKY */
.fix-r { position: sticky; z-index: 900 !important; background-color: #fff; text-align: center; } /* Body Right > Standard Body */
.attendance-table thead .fix-r { z-index: 1000 !important; background-color: #f8fafc; } /* Header Right > Header Standard */

/* UTILS */
.is-sunday { background-color: #dcfce7 !important; }
.shadow-left { box-shadow: -3px 0 5px -2px rgba(0,0,0,0.1); }

/* Inputs Styles */
.att-input { 
    width: 100%; 
    border: none; 
    text-align: center; 
    background: transparent; 
    display: block; 
    cursor: pointer; 
    font-family: 'Inter', sans-serif;
    outline: none;
}
.att-input.symbol { 
    font-weight: 800; 
    text-transform: uppercase; 
    height: 24px;
    font-size: 0.9rem;
    border-bottom: 1px solid #e2e8f0; /* Tách biệt rõ ràng */
}
/* Màu sắc ký hiệu chuẩn */
.att-input.symbol[value="X"] { color: #166534; } /* Xanh lá đậm */
.att-input.symbol[value="P"] { color: #1e40af; } /* Xanh dương */
.att-input.symbol[value="L,T"], .att-input.symbol[value="L"], .att-input.symbol[value="T"] { color: #991b1b; } /* Đỏ đậm */
.att-input.symbol[value="OF"] { color: #64748b; font-weight: 400; }

.att-input.ot { 
    font-size: 0.75rem; 
    color: #c2410c; /* Màu cam đỏ cho tăng ca */
    font-weight: 600;
    height: 18px; 
}

/* Ẩn nút tăng giảm (spinner) trong input number */
.att-input.ot::-webkit-outer-spin-button,
.att-input.ot::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.att-input.ot {
    -moz-appearance: textfield;
}

.att-input:focus { background-color: rgba(0,0,0,0.05); }
.att-input.changed { background-color: #fef3c7 !important; border-radius: 2px; } /* Vàng nhạt cho ô vừa sửa */

/* DARK MODE */
body.dark-mode .attendance-table thead th, 
body.dark-mode .fix-l, body.dark-mode .fix-r { background-color: #1e293b !important; color: #94a3b8; border-color: #334155; }        
body.dark-mode .attendance-table td { background-color: #1e293b; border-color: #334155; }
body.dark-mode .is-sunday { background-color: rgba(22, 101, 52, 0.25) !important; }

/* Màu sắc ký hiệu trong Dark Mode */
body.dark-mode .att-input.symbol { color: #cbd5e1; } /* Mặc định */
body.dark-mode .att-input.symbol[value="X"] { color: #4ade80; }
body.dark-mode .att-input.symbol[value="P"] { color: #60a5fa; }
body.dark-mode .att-input.symbol[value="L,T"], body.dark-mode .att-input.symbol[value="L"], body.dark-mode .att-input.symbol[value="T"] { color: #f87171; }
body.dark-mode .att-input.ot { color: #fb923c; }
body.dark-mode .att-input.changed { background-color: #451a03 !important; color: #fff; }
</style>

    <!-- Footer Content -->
    <footer class="main-footer">
        &copy; 2026 Khaservice HR Management System. All rights reserved.
    </footer>
    </div> <!-- End Main Content -->
</div> <!-- End Wrapper -->

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/khaservice-hr/assets/js/main.js"></script>
<script>
    $(document).ready(function() {
        // Show Toast from Session
            });
</script>
</body>
</html>

<script>
let changedData = {}; 

$(document).ready(function() {
    // Khởi tạo giá trị gốc cho tất cả các ô để so sánh thay đổi
    $('.att-input').each(function() {
        $(this).data('original', $(this).val());
    });
});

// 1. Theo dõi thay đổi
$(document).on('change', '.att-input', function() {
    let currentVal = $(this).val();
    let originalVal = $(this).data('original');
    let tr = $(this).closest('tr');
    let day = $(this).data('day');
    let key = `${tr.data('emp-id')}_${day}`;

    if (currentVal !== originalVal) {
        $(this).addClass('changed');
        changedData[key] = { 
            emp_id: tr.data('emp-id'), 
            day: day, 
            symbol: tr.find(`.symbol[data-day="${day}"]`).val(), 
            ot: tr.find(`.ot[data-day="${day}"]`).val() || 0 
        };
    } else {
        $(this).removeClass('changed');
        delete changedData[key];
    }
    calculateRow(tr);
});

// 2. Xóa nhanh bằng phím Delete
$(document).on('keydown', '.att-input', function(e) {
    if (e.keyCode === 46 || e.keyCode === 8) { // Delete hoặc Backspace
        if ($(this).val() !== '') {
            $(this).val('').trigger('change');
        }
    }
});

// 3. Tính toán Real-time
function calculateRow(tr) {
    let s = {p_cd:0, other:0, holiday:0, ot_norm:0, ot_sun:0, ot_hol:0, total:0};
    tr.find('.symbol').each(function() {
        let d = $(this).data('day'); 
        let sym = $(this).val().toUpperCase().trim();
        let ot = parseFloat(tr.find(`.ot[data-day="${d}"]`).val()) || 0;
        let isSun = $(this).data('is-sunday') == '1';
        
        // 1. Tính toán ngày nghỉ & công
        // Tổng công thực tế (Theo công thức Excel: X + 1/2*0.5 + 1/p*0.5 + ĐH)
        
        if (['X', 'ĐH', 'DH'].includes(sym)) { s.total += 1; }
        else if (sym == '1/2') { s.total += 0.5; }
        else if (['1/P', '1/CĐ', '1/CD'].includes(sym)) { s.total += 0.5; s.p_cd += 0.5; } // 0.5 công + 0.5 phép
        else if (['F', 'F1'].includes(sym)) { s.total += 1; } // Làm ngày lễ/CN cũng là 1 công
        else if (['1/F1', '1/LT'].includes(sym)) { s.total += 0.5; }

        // Tính ngày nghỉ (để hiển thị vào cột P/CĐ, Khác, Lễ)
        if (['P', 'CĐ', 'CD'].includes(sym)) { s.p_cd += 1; } // Nghỉ nguyên ngày -> Ko cộng vào Total
        else if (['Ô', 'O', 'TS', 'R', 'VR', 'CO', 'NB'].includes(sym)) { s.other += 1; }
        else if (['L', 'T', 'L,T', 'L, T'].includes(sym)) { s.holiday += 1; }

        // 2. Tính toán Tăng ca (OT)
        if (ot > 0) {
            if (['F', 'L', 'T', 'L,T', 'L, T'].includes(sym)) s.ot_hol += ot;
            else if (['F1'].includes(sym) || isSun) s.ot_sun += ot;
            else s.ot_norm += ot;
        }
    });
    
    tr.find('.sum-p-cd').text(s.p_cd || ''); 
    tr.find('.sum-other').text(s.other || ''); 
    tr.find('.sum-holiday').text(s.holiday || '');
    tr.find('.sum-ot-normal').text(s.ot_norm || ''); 
    tr.find('.sum-ot-sun').text(s.ot_sun || ''); 
    tr.find('.sum-ot-hol').text(s.ot_hol || '');
    tr.find('.sum-total').text(s.total || '0');
}

function toggleSymbol(input) { 
    let $i = $(input); 
    let cur = $i.val().toUpperCase(); 
    $i.val((cur===''||cur=='OF')?'X':'').trigger('change'); 
}

function saveAttendance() {
    let payload = [];
    
    $('tr[data-emp-id]').each(function() {
        let tr = $(this);
        let empId = tr.data('emp-id');
        
        tr.find('.att-input.symbol').each(function() {
            let day = $(this).data('day');
            let symbolInput = $(this);
            let otInput = tr.find(`.ot[data-day="${day}"]`);
            
            let symVal = symbolInput.val();
            let otVal = otInput.val();
            
            let symOrg = symbolInput.data('original'); // Giá trị lúc load trang
            let otOrg = otInput.data('original');
            
            // Logic quyết định gửi:
            // 1. Nếu có dữ liệu (sym hoặc ot khác rỗng/0) -> Gửi (để Insert/Update)
            // 2. Nếu hiện tại rỗng NHƯNG gốc có dữ liệu -> Gửi (để xóa về NULL)
            // 3. Nếu gốc rỗng và hiện tại rỗng -> Bỏ qua.
            
            let hasDataNow = (symVal !== '' || (otVal !== '' && otVal != 0));
            let hadDataBefore = (symOrg !== '' || (otOrg !== '' && otOrg != 0));
            
            // So sánh thay đổi (để chắc chắn không gửi dữ liệu thừa nếu chưa sửa gì)
            // Tuy nhiên, để "chắc ăn" như bạn muốn, ta có thể gửi hết những ô hasDataNow.
            // Nhưng tốt nhất là chỉ gửi những ô CÓ SỰ KHÁC BIỆT so với Original.
            // Vì nếu Original = X, Current = X -> Gửi làm gì?
            
            let isChanged = (symVal !== symOrg) || (otVal !== otOrg);
            
            if (isChanged) {
                payload.push({
                    emp_id: empId,
                    day: day,
                    symbol: symVal,
                    ot: otVal || 0
                });
            }
        });
    });

    if (payload.length === 0) return Toast.info('Không có thay đổi nào so với dữ liệu gốc.');
    
    let $btn = $('button[onclick="saveAttendance()"]'); 
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');
    
    fetch('save.php', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ 
            month: 1, 
            year: 2026, 
            project_id: 13, 
            changes: payload 
        })
    }).then(r => r.json()).then(data => { 
        if (data.status === 'success') { 
            Toast.success(data.message); 
            $('.att-input.changed').removeClass('changed'); 
            // Cập nhật lại original để lần lưu sau đúng
            $('.att-input').each(function() { $(this).data('original', $(this).val()); });
            changedData = {}; // Clear buffer cũ (không dùng nữa nhưng cứ clear)
        } else {
            Toast.error(data.message);
        }
    }).catch(err => {
        Toast.error('Lỗi kết nối máy chủ.');
        console.error(err);
    }).finally(() => {
        $btn.prop('disabled', false).html('<i class="fas fa-save"></i> Lưu dữ liệu');
    });
}

/* --- 6. Advanced Drag & Drop Logic (Excel-like) --- */
let isDragging = false;
let startCell = null;
let selectionRange = []; // Array of elements

// Ngăn trình duyệt xử lý kéo thả text mặc định
$(document).on('dragstart', '.att-input', function(e) {
    e.preventDefault();
    return false;
});

$(document).on('mousedown', '.att-input', function(e) {
    if (e.button !== 0) return;

    isDragging = true;
    startCell = $(this); // Chính xác là input đang click
    
    if ($(this).hasClass('symbol')) dragType = 'symbol';
    else if ($(this).hasClass('ot')) dragType = 'ot';
    
    // Highlight ngay ô đầu tiên
    $('.att-input.drag-selected').removeClass('drag-selected');
    $('.att-input.selected-cell').removeClass('selected-cell'); 
    
    $(this).addClass('selected-cell'); 
    $(this).focus(); 
});

$(document).on('mousemove', 'td', function(e) {
    if (!isDragging || !startCell) return;
    
    if (e.buttons !== 1) {
        isDragging = false;
        return;
    }

    // FIX: Chỉ tìm input cùng loại với loại đang kéo
    let input = $(this).find('.' + dragType);
    if (input.length === 0) return;

    // Không cần check currentType nữa vì ta đã find đúng class
    let startRow = startCell.closest('tr')[0];
    let currentRow = $(this).closest('tr')[0];

    if (startRow === currentRow) { // Chỉ cần check cùng dòng
        $('.att-input.drag-selected').removeClass('drag-selected');
        
        let startIdx = startCell.parent().index(); 
        let currentIdx = $(this).index();
        let minIdx = Math.min(startIdx, currentIdx);
        let maxIdx = Math.max(startIdx, currentIdx);

        let tr = $(startRow);
        tr.find('td').slice(minIdx, maxIdx + 1).each(function() {
            let item = $(this).find('.' + dragType); // Find đúng loại
            if (item.length) {
                item.addClass('drag-selected');
                selectionRange.push(item);
            }
        });
    }
});

$(document).on('mouseup', function() {
    if (isDragging && startCell && selectionRange.length > 1) {
        let valToCopy = startCell.val();
        
        if (valToCopy !== '') {
            let tr = startCell.closest('tr');
            let affected = false;
            
            selectionRange.forEach(function(el) {
                if (el[0] !== startCell[0]) { 
                    el.val(valToCopy).trigger('change');
                    affected = true;
                }
            });
            if (affected) calculateRow(tr);
        }
    }
    isDragging = false;
    // Không xóa vùng chọn ở đây để cho phép user bấm Delete tiếp theo
});

// Xử lý phím Delete cho vùng chọn HOẶC ô hiện tại
$(document).on('keydown', function(e) {
    if (e.keyCode === 46 || e.keyCode === 8) { // Delete or Backspace
        let hasSelection = selectionRange.length > 0 && $('.drag-selected').length > 0;
        
        if (hasSelection) {
            e.preventDefault();
            let tr = selectionRange[0].closest('tr');
            let affected = false;
            
            selectionRange.forEach(function(el) {
                if (el.val() !== '') {
                    el.val('').trigger('change');
                    affected = true;
                }
            });
            
            if (affected) calculateRow(tr);
            
            // Sau khi xóa xong thì bỏ chọn
            $('.att-input.drag-selected').removeClass('drag-selected');
            $('.att-input.selected-cell').removeClass('selected-cell');
            selectionRange = [];
        } else {
            // Xóa ô đơn lẻ đang focus (nếu không có vùng chọn)
            let focused = $(':focus');
            if (focused.hasClass('att-input') && focused.val() !== '') {
                e.preventDefault();
                focused.val('').trigger('change');
            }
        }
    }
});

// Click ra ngoài thì bỏ chọn
$(document).on('click', function(e) {
    if (!$(e.target).closest('.attendance-table').length) {
        $('.att-input.drag-selected').removeClass('drag-selected');
        $('.att-input.selected-cell').removeClass('selected-cell');
        selectionRange = [];
    }
});

// CSS cho vùng chọn kéo thả (High Contrast)
$('head').append('<style>.drag-selected { background-color: #60a5fa !important; color: #fff !important; outline: 2px solid #2563eb !important; z-index: 9999 !important; position: relative; box-shadow: 0 0 5px rgba(37, 99, 235, 0.5); } .selected-cell { outline: 2px solid #2563eb !important; z-index: 9999; position: relative; }</style>');
</script>
